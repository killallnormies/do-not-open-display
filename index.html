<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DO NOT OPEN</title>
    <!-- FULLSCREEN / PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            box-sizing: border-box;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
        }

        #display {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            padding: 5vw;
        }

        #message {
            font-size: 6vw;
            font-weight: bold;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            opacity: 0;
            transition: opacity 0.5s;
        }

        #status {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 14px;
            color: #555;
        }

        video,
        canvas {
            display: none;
        }
    </style>
</head>

<body>
    <div id="display">
        <div id="message"></div>
    </div>
    <div id="status">● OFFLINE</div>

    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>

    <script>
        // CONFIGURATION
        // NOTE: Cloud Run usually allows WSS on 443. 
        const WS_URL = 'wss://do-not-open-618512691492.us-central1.run.app/ws';

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const msgEl = document.getElementById('message');
        const statusEl = document.getElementById('status');

        let ws;
        let isLooping = false;
        let currentCycle = 0;

        // INIT
        window.onload = init;

        async function init() {
            try {
                // Camera
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = stream;

                // Fullscreen trigger
                document.body.addEventListener('click', () => {
                    document.documentElement.requestFullscreen().catch(() => { });
                    // Also try to start audio context if needed
                    speak(''); // Warmup TTS
                });

                connect();
            } catch (e) {
                msgEl.innerText = "CAMERA FAIL";
                msgEl.style.opacity = 1;
            }
        }

        function connect() {
            statusEl.innerText = "● CONNECTING...";
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                statusEl.innerText = "● ONLINE";
                if (!isLooping) startConversationLoop();
            };

            ws.onmessage = handleMessage;

            ws.onclose = () => {
                statusEl.innerText = "● DISCONNECTED";
                setTimeout(connect, 1000); // Auto-reconnect
            };

            ws.onerror = (e) => {
                console.error("WS Error", e);
            };
        }

        function startConversationLoop() {
            isLooping = true;
            captureAndSend();
        }

        function captureAndSend() {
            if (ws.readyState !== WebSocket.OPEN) return;

            currentCycle++;
            statusEl.innerText = `● SCANNING [${currentCycle}]`;

            // Capture
            canvas.width = 512; canvas.height = 512;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const b64 = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];

            // Send
            ws.send(JSON.stringify({ image: b64 }));
            statusEl.innerText = `● THINKING...`;
        }

        function handleMessage(event) {
            const data = JSON.parse(event.data);
            const text = data.message;

            if (!text || text.includes("NOBODY")) {
                // Clear screen
                msgEl.style.opacity = 0;
                statusEl.innerText = "● IDLE";
                // Scan again in 2s
                setTimeout(captureAndSend, 2000);
            } else {
                // PERSON DETECTED
                // Artificial "Thinking" Delays
                statusEl.innerText = "● PROCESSING";

                setTimeout(() => {
                    // Display
                    msgEl.innerText = text;
                    msgEl.style.opacity = 1;
                    statusEl.innerText = "● SPEAKING";

                    // Voice
                    speak(text);

                    // Schedule next scan based on length
                    // (Reading time + speaking time)
                    const delay = Math.max(4000, 2000 + (text.split(' ').length * 500));
                    setTimeout(() => {
                        msgEl.style.opacity = 0;
                        setTimeout(captureAndSend, 500);
                    }, delay);

                }, 1500); // 1.5s initial artificial pause
            }
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            if (!text) return;
            const u = new SpeechSynthesisUtterance(text);
            u.rate = 0.85;
            u.pitch = 0.7;
            window.speechSynthesis.speak(u);
        }

    </script>
</body>

</html>